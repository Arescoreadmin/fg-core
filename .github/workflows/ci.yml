# NOTE:
# - Console/Compliance gating uses dorny/paths-filter, because GitHub Actions does not provide reliable
#   per-job changed-files expressions.
# - DRY setup is implemented via composite actions in .github/actions/.

name: frostgate-core-ci

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: frostgate-core-ci-${{ github.ref }}
  cancel-in-progress: true

# Least-privilege defaults for the whole workflow.
# Jobs that need more can override.
permissions:
  contents: read

env:
  PYTHONHASHSEED: "0"
  TZ: "UTC"

defaults:
  run:
    shell: bash

jobs:
  fg_guard:
    name: Guard (paths + syntax + fg-fast)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    env:
      FG_ENV: dev
      FG_AUTH_ENABLED: "1"
      FG_ENFORCEMENT_MODE: observe
      FG_SQLITE_PATH: state/frostgate-ci-guard.db

    outputs:
      console: ${{ steps.filter.outputs.console }}
      compliance: ${{ steps.filter.outputs.compliance }}
      python: ${{ steps.filter.outputs.python }}
      core: ${{ steps.filter.outputs.core }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            python:
              - "**/*.py"
              - "pyproject.toml"
              - "requirements*.txt"
              - "uv.lock"
              - "poetry.lock"
            core:
              - "api/**"
              - "engine/**"
              - "tests/**"
              - "Makefile"
              - ".github/**"
              - "CONTRACT.md"
              - "README.md"
              - "policy/**"
              - "migrations/**"
              - "scripts/**"
            console:
              - "console/**"
              - "package.json"
              - "package-lock.json"
              - ".github/**"
            compliance:
              - "compliance/**"
              - "Makefile"
              - ".github/**"
              - "pyproject.toml"
              - "requirements*.txt"
              - "uv.lock"
              - "poetry.lock"

      - name: Generate CI secrets
        uses: ./.github/actions/fg-secrets

      - name: Python setup (cached)
        uses: ./.github/actions/fg-python-setup
        with:
          python-version: "3.12"
          install-os-deps: "true"
          prepare-workspace: "true"
          build-venv: "true"

      - name: Verify FG_API_KEY is set
        run: python -c "import os; assert os.getenv('FG_API_KEY')"

      - name: Syntax / import guard (fast fail)
        run: python -m compileall -q api engine tests

      - name: Run fg-fast guard lane (lock regression)
        run: make fg-fast
        env:
          FG_API_KEY: ${{ env.FG_API_KEY }}

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frostgate-guard-artifacts
          path: |
            artifacts/**
            state/**
          if-no-files-found: ignore

  unit:
    name: Unit (ci)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: fg_guard
    if: ${{ github.event_name == 'pull_request' || needs.fg_guard.outputs.core == 'true' || needs.fg_guard.outputs.python == 'true' }}
    permissions:
      contents: read
    env:
      FG_ENV: dev
      FG_AUTH_ENABLED: "1"
      FG_ENFORCEMENT_MODE: observe
      FG_SQLITE_PATH: state/frostgate-ci.db

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate CI secrets
        uses: ./.github/actions/fg-secrets

      - name: Python setup (cached)
        uses: ./.github/actions/fg-python-setup
        with:
          python-version: "3.12"
          install-os-deps: "true"
          prepare-workspace: "true"
          build-venv: "true"

      - name: Verify FG_API_KEY is set
        run: python -c "import os; assert os.getenv('FG_API_KEY')"

      - name: Production profile check (fail-fast on unsafe defaults)
        run: make prod-profile-check

      - name: Gap audit (fail if Production-blocking gaps exist)
        run: make gap-audit

      - name: Run unit lane
        run: make ci
        env:
          FG_API_KEY: ${{ env.FG_API_KEY }}

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frostgate-unit-artifacts
          path: |
            artifacts/**
            state/**
          if-no-files-found: ignore

  contract_authority:
    name: Contract Authority (prod-spec)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: fg_guard
    if: ${{ github.event_name == 'pull_request' || needs.fg_guard.outputs.core == 'true' || needs.fg_guard.outputs.python == 'true' }}
    permissions:
      contents: read
    env:
      FG_ENV: prod
      FG_CONTRACT_SPEC: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Python setup (cached)
        uses: ./.github/actions/fg-python-setup
        with:
          python-version: "3.12"
          install-os-deps: "true"
          prepare-workspace: "true"
          build-venv: "true"

      - name: Verify prod OpenAPI contract drift
        run: make contracts-core-diff

      - name: Verify contract authority markers
        run: make contract-authority-check

  integration:
    name: Integration (itest-local)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: unit
    if: ${{ always() && needs.unit.result == 'success' }}
    permissions:
      contents: read
    env:
      FG_ENV: dev
      FG_AUTH_ENABLED: "1"
      FG_ENFORCEMENT_MODE: observe
      FG_SQLITE_PATH: state/frostgate-ci-integration.db
      ITEST_HOST: 127.0.0.1
      ITEST_PORT: 8001
      ITEST_WIPE_DB: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate CI secrets
        uses: ./.github/actions/fg-secrets

      - name: Python setup (cached)
        uses: ./.github/actions/fg-python-setup
        with:
          python-version: "3.12"
          install-os-deps: "true"
          prepare-workspace: "true"
          build-venv: "true"

      - name: Verify FG_API_KEY is set
        run: python -c "import os; assert os.getenv('FG_API_KEY')"

      - name: Syntax / import guard (fast fail)
        run: python -m compileall -q api engine tests

      - name: Run integration lane
        run: make ci-integration

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frostgate-integration-artifacts
          path: |
            artifacts/**
            state/**
          if-no-files-found: ignore

  db_postgres_verify:
    name: DB Postgres Verify
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: fg_guard
    if: ${{ github.event_name == 'pull_request' || needs.fg_guard.outputs.core == 'true' || needs.fg_guard.outputs.python == 'true' }}
    permissions:
      contents: read
    env:
      FG_ENV: test
      FG_DB_BACKEND: postgres
      POSTGRES_USER: fg_user
      POSTGRES_DB: frostgate
      POSTGRES_PASSWORD: fg_password
      FG_DB_URL: postgresql+psycopg://fg_user:fg_password@127.0.0.1:5432/frostgate

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Python setup (cached)
        uses: ./.github/actions/fg-python-setup
        with:
          python-version: "3.12"
          install-os-deps: "true"
          prepare-workspace: "true"
          build-venv: "true"

      - name: Create .env for compose
        run: |
          set -euo pipefail
          printf "POSTGRES_USER=%s\nPOSTGRES_DB=%s\nPOSTGRES_PASSWORD=%s\nREDIS_PASSWORD=%s\nFG_AGENT_API_KEY=%s\nAG_CORS_ORIGINS=%s\nNATS_AUTH_TOKEN=%s\nFG_API_KEY=%s\n" \
            "${POSTGRES_USER}" "${POSTGRES_DB}" "${POSTGRES_PASSWORD}" "devredis" "dev-agent-key" "http://localhost:13000" "ci-nats-token" "ci-api-key" > .env

      - name: Run Postgres verification lane
        run: make db-postgres-verify

  admin:
    name: Admin Gateway (ci-admin)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: fg_guard
    if: ${{ github.event_name == 'pull_request' || needs.fg_guard.outputs.core == 'true' || needs.fg_guard.outputs.python == 'true' }}
    permissions:
      contents: read
    env:
      FG_ENV: dev
      FG_AUTH_ENABLED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Generate CI secrets
        uses: ./.github/actions/fg-secrets
      - name: Python setup (cached)
        uses: ./.github/actions/fg-python-setup
        with:
          python-version: "3.12"
          install-os-deps: "true"
          prepare-workspace: "false"
          build-venv: "true"
      - name: Verify FG_API_KEY is set
        run: python -c "import os; assert os.getenv('FG_API_KEY')"
      - name: Syntax / import guard (fast fail)
        run: python -m compileall -q api engine tests
      - name: Run admin gateway lane
        run: make ci-admin

  console:
    name: Console (ci-console)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: fg_guard
    if: ${{ github.event_name == 'pull_request' || needs.fg_guard.outputs.console == 'true' }}
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Node (cached)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            console/package-lock.json
            package-lock.json

      - name: Generate CI secrets
        uses: ./.github/actions/fg-secrets

      - name: Run console lane
        run: make ci-console

  pt:
    name: PT (ci-pt)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: fg_guard
    if: ${{ github.event_name == 'pull_request' || needs.fg_guard.outputs.core == 'true' || needs.fg_guard.outputs.python == 'true' }}
    permissions:
      contents: read
    env:
      FG_ENV: dev
      FG_AUTH_ENABLED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Generate CI secrets
        uses: ./.github/actions/fg-secrets
      - name: Python setup (cached)
        uses: ./.github/actions/fg-python-setup
        with:
          python-version: "3.12"
          install-os-deps: "true"
          prepare-workspace: "false"
          build-venv: "true"
      - name: Verify FG_API_KEY is set
        run: python -c "import os; assert os.getenv('FG_API_KEY')"
      - name: Syntax / import guard (fast fail)
        run: python -m compileall -q api engine tests
      - name: Run PT lane
        run: make ci-pt

  hardening:
    name: Hardening Gates (ci-hardening)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: fg_guard
    if: ${{ github.event_name == 'pull_request' || needs.fg_guard.outputs.core == 'true' || needs.fg_guard.outputs.python == 'true' }}
    permissions:
      contents: read
    env:
      FG_ENV: dev
      FG_AUTH_ENABLED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Generate CI secrets
        uses: ./.github/actions/fg-secrets
      - name: Python setup (cached)
        uses: ./.github/actions/fg-python-setup
        with:
          python-version: "3.12"
          install-os-deps: "true"
          prepare-workspace: "false"
          build-venv: "true"
      - name: Verify FG_API_KEY is set
        run: python -c "import os; assert os.getenv('FG_API_KEY')"

      - name: Run Core Invariants (INV-001..INV-007)
        run: make test-core-invariants
        env:
          FG_API_KEY: ${{ env.FG_API_KEY }}

      - name: Syntax / import guard (fast fail)
        run: python -m compileall -q api engine tests

      # ✅ Added: explicit security regression lane (your request)
      - name: Security regression tests
        run: pytest tests/security -q

      - name: Run Hardening Tests - Decision Pipeline Unity
        run: make test-decision-unified
      - name: Run Hardening Tests - Tenant Isolation
        run: make test-tenant-isolation
      - name: Run Hardening Tests - Auth Hardening
        run: make test-auth-hardening

  compliance:
    name: Compliance Gates
    runs-on: ubuntu-latest
    timeout-minutes: 35
    needs: fg_guard
    if: ${{ github.event_name == 'pull_request' || needs.fg_guard.outputs.compliance == 'true' }}
    permissions:
      contents: read
    env:
      FG_ENV: dev
      FG_AUTH_ENABLED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate CI secrets
        uses: ./.github/actions/fg-secrets

      - name: Python setup (cached)
        uses: ./.github/actions/fg-python-setup
        with:
          python-version: "3.12"
          install-os-deps: "false"
          prepare-workspace: "true"
          build-venv: "true"

      - name: Syntax / import guard (fast fail)
        run: python -m compileall -q api engine tests

      - name: Generate SBOM
        run: make compliance-sbom

      - name: Generate Provenance
        run: make compliance-provenance

      - name: Run CIS Checks
        run: make compliance-cis

      - name: Run SCAP Scan
        run: make compliance-scap

      - name: Verify Compliance Artifacts
        run: |
          set -euo pipefail
          test -f artifacts/sbom.json || (echo "SBOM missing" && exit 1)
          test -f artifacts/provenance.json || (echo "Provenance missing" && exit 1)
          test -f artifacts/cis_check.json || (echo "CIS check missing" && exit 1)
          test -f artifacts/scap_scan.json || (echo "SCAP scan missing" && exit 1)
          echo "All compliance artifacts generated"

      - name: Upload Compliance Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frostgate-compliance-artifacts
          path: |
            artifacts/sbom.json
            artifacts/provenance.json
            artifacts/cis_check.json
            artifacts/scap_scan.json
          if-no-files-found: error

  evidence:
    name: Evidence (ci-evidence)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: integration
    if: ${{ always() && needs.integration.result == 'success' }}
    permissions:
      contents: read
    env:
      FG_ENV: dev
      FG_AUTH_ENABLED: "1"
      FG_ENFORCEMENT_MODE: observe
      FG_SQLITE_PATH: state/frostgate-ci-evidence.db
      ITEST_HOST: 127.0.0.1
      ITEST_PORT: 8001
      ITEST_WIPE_DB: "1"
      SCENARIO: spike

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate CI secrets
        uses: ./.github/actions/fg-secrets

      - name: Python setup (cached)
        uses: ./.github/actions/fg-python-setup
        with:
          python-version: "3.12"
          install-os-deps: "true"
          prepare-workspace: "true"
          build-venv: "true"

      - name: Verify FG_API_KEY is set
        run: python -c "import os; assert os.getenv('FG_API_KEY')"

      - name: Syntax / import guard (fast fail)
        run: python -m compileall -q api engine tests

      - name: Run evidence lane (server + smoke + evidence)
        run: make ci-evidence

      - name: Install minisign (for signature verification)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends minisign
          minisign -V || true

      - name: Verify signature
        env:
          MINISIGN_SECRET_KEY: ${{ secrets.MINISIGN_SECRET_KEY || '' }}
          MINISIGN_PUBLIC_KEY: ${{ secrets.MINISIGN_PUBLIC_KEY || '' }}
        run: |
          set -euo pipefail
          out="$(cat artifacts/latest_evidence_dir.txt)"

          # If minisig missing:
          # - On PRs (no secret key), we skip (expected for forks).
          # - If secret key exists but minisig is missing, fail hard.
          if [ ! -f "$out/manifest.sha256.minisig" ]; then
            if [ -z "${MINISIGN_SECRET_KEY:-}" ]; then
              echo "⚠️ Skipping signature verification: MINISIGN_SECRET_KEY not available (expected for PRs/forks)"
              exit 0
            fi
            echo "❌ missing minisig (but MINISIGN_SECRET_KEY was set)"
            exit 1
          fi

          # Prefer repo key if present, else fall back to secret public key
          if [ -f keys/minisign.pub ]; then
            PUB="$(cat keys/minisign.pub)"
          else
            test -n "${MINISIGN_PUBLIC_KEY:-}" || (echo "❌ no public key (keys/minisign.pub or MINISIGN_PUBLIC_KEY)" && exit 1)
            PUB="${MINISIGN_PUBLIC_KEY}"
          fi

          minisign -Vm "$out/manifest.sha256" -P "$PUB"
          echo "✅ signature verified"

      - name: Upload evidence zip
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frostgate-evidence-bundle
          path: |
            artifacts/frostgate_evidence_*.zip
            artifacts/latest_zip*.txt
            artifacts/latest_evidence_dir*.txt
            artifacts/**
            state/**
          if-no-files-found: error
