name: frostgate-docker-ci

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  docker-validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate CI secrets
        run: |
          python - <<'PY' >> "$GITHUB_ENV"
          import secrets
          print(f"FG_API_KEY={secrets.token_urlsafe(32)}")
          print(f"REDIS_PASSWORD={secrets.token_urlsafe(24)}")
          print(f"POSTGRES_PASSWORD={secrets.token_urlsafe(24)}")
          print(f"FG_AGENT_API_KEY={secrets.token_urlsafe(24)}")
          PY

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare environment
        run: |
          cp .env.example .env.ci
          mkdir -p secrets
          {
            echo "FG_API_KEY=${FG_API_KEY}"
            echo "REDIS_PASSWORD=${REDIS_PASSWORD}"
            echo "POSTGRES_PASSWORD=${POSTGRES_PASSWORD}"
            echo "FG_AGENT_API_KEY=${FG_AGENT_API_KEY}"
          } >> .env.ci
          echo "${FG_API_KEY}" > secrets/fg_api_keys.txt

      - name: Build images via docker compose
        run: |
          docker compose --env-file .env.ci build

      - name: Start stack
        run: |
          docker compose --env-file .env.ci up -d

      - name: Smoke test /health
        run: |
          echo "Waiting for core-api to come up..."
          for i in $(seq 1 20); do
            if curl -sSf http://127.0.0.1:18080/health >/dev/null; then
              echo "core-api is healthy"
              exit 0
            fi
            sleep 2
          done
          echo "core-api failed to become healthy in time"
          docker compose logs
          exit 1

      - name: Dump docker compose logs on failure
        if: failure()
        run: |
          docker compose --env-file .env.ci logs || true

      - name: Tear down stack
        if: always()
        run: |
          docker compose --env-file .env.ci down -v || true
