qfrom __future__ import annotations

import logging
import os

from fastapi import FastAPI
from prometheus_fastapi_instrumentator import Instrumentator

from api.db import db_ping, init_db
from api.decisions import router as decisions_router
from api.defend import router as defend_router

# ---------- Logging ----------
logger = logging.getLogger("frostgate")
logging.basicConfig(
    level=os.getenv("FG_LOG_LEVEL", "INFO").upper(),
    format="%(asctime)s %(levelname)s %(name)s %(message)s",
)

# ---------- FastAPI app ----------
app = FastAPI(
    title="Frostgate Core",
    version="0.1.0",
    description="MVP defense API for Frostgate Core.",
)

# Metrics
if os.getenv("FG_METRICS_ENABLED", "true").lower() == "true":
    Instrumentator().instrument(app).expose(app)

# Routers (these own auth + behavior)
app.include_router(defend_router)
app.include_router(decisions_router)

# ---------- Startup ----------
@app.on_event("startup")
def _startup_init_db() -> None:
    init_db()
    logger.info("DB initialized")

# ---------- Health ----------
@app.get("/health/live")
async def health_live() -> dict[str, str]:
    return {"status": "ok"}

@app.get("/health/ready")
async def health_ready() -> dict[str, str]:
    # Strict readiness optionally checks DB connectivity
    if os.getenv("FG_READY_CHECK_DB", "true").lower() == "true":
        if not db_ping():
            return {"status": "degraded"}
    return {"status": "ok"}

@app.get("/")
async def root() -> dict[str, str]:
    return {"service": "frostgate-core", "status": "ok"}
