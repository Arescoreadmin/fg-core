# DRIFT_LEDGER

Each item below is a concrete drift against `BLUEPRINT_STAGED.md` or the MVP
contract. When something is missing, it is labeled **MISSING** and paired with a
minimal, production-grade fix strategy.

| Drift ID | Category | Spec requirement (quote + file:line) | Repo reality (quote + file:line) | Severity | Fix strategy | CI enforcement | Patch set |
| --- | --- | --- | --- | --- | --- | --- | --- |
| DR-001 | CI gap | “Enforced By: tools/align_score.py, tools/drift_check.py, CI job blueprint_gate” (BLUEPRINT_STAGED.md:L10-L12) | “jobs: fg_guard … contract_authority … integration … hardening … compliance … evidence” (no blueprint_gate job listed) (.github/workflows/ci.yml:L31-L210) | HIGH | Add `blueprint_gate` job running `tools/align_score.py` + `tools/drift_check.py` with a fail-on-missing flag. | Add job to `.github/workflows/ci.yml` to run `make align-score` + `make verify-drift`. | `.github/workflows/ci.yml` |
| DR-002 | Blueprint gap | “BP-S0-001 Deterministic startup + probes” (BLUEPRINT_STAGED.md:L91) | “BP-S0-001”: “MISSING” (tools/align_score_map.json:L2) | HIGH | Add readiness checks for OPA + NATS + DB and enforce in `/health/ready`. | Add `pytest tests/test_main_integrity.py -q` covering readiness. | `api/main.py`, `tests/test_main_integrity.py` |
| DR-003 | Ops gap | “BP-S0-005 Centralized auditable logs” (BLUEPRINT_STAGED.md:L99) | “BP-S0-005”: “MISSING” (tools/align_score_map.json:L6) | MED | Add centralized audit log sink (append-only table + export job). | Add `pytest tests/test_security_audit_fixes.py -q` assertions + CI gate. | `api/security_audit.py`, `migrations/postgres/*`, `tests/security/*` |
| DR-004 | Blueprint gap | “BP-M1-006 Evidence stored immutably (at least append-only semantics)” (BLUEPRINT_STAGED.md:L115) | “BP-M1-006”: “MISSING” (tools/align_score_map.json:L12) | HIGH | Enforce append-only triggers + schema for evidence artifacts in all backends. | Add `make db-postgres-assert` to required CI lanes. | `migrations/postgres/*`, `api/db_migrations.py` |
| DR-005 | Blueprint gap | “BP-M2-001 Policy registry (versioned, immutable)” (BLUEPRINT_STAGED.md:L121) | “BP-M2-001”: “MISSING” (tools/align_score_map.json:L13) | HIGH | Introduce policy registry table + immutable writes + hash pinning. | Add `pytest tests/test_governance_approval_flow.py -q` extension to validate registry. | `api/governance.py`, `migrations/postgres/*`, `tests/test_governance_approval_flow.py` |
| DR-006 | Blueprint gap | “BP-M2-002 Config registry (tenant-scoped, versioned)” (BLUEPRINT_STAGED.md:L123) | “BP-M2-002”: “MISSING” (tools/align_score_map.json:L14) | HIGH | Add tenant config registry with versioned entries + fetch endpoint. | Add `pytest tests/test_tenant_invariant.py -q` coverage for registry access. | `api/config_registry.py` (new), `migrations/postgres/*`, `api/main.py` |
| DR-007 | Blueprint gap | “BP-M2-003 Rollout primitives: pin/stage/rollback” (BLUEPRINT_STAGED.md:L125) | “BP-M2-003”: “MISSING” (tools/align_score_map.json:L15) | HIGH | Implement rollout primitives with version pinning APIs. | Add `pytest tests/test_sim_validator.py -q` plus new rollout tests. | `api/governance.py`, `tests/test_sim_validator.py` |
| DR-008 | Blueprint gap | “BP-M3-001 Evidence ledger append-only + verifiable” (BLUEPRINT_STAGED.md:L139) | “BP-M3-001”: “MISSING” (tools/align_score_map.json:L20) | HIGH | Implement verifiable ledger (hash chain + verification endpoint). | Add `pytest tests/test_merkle_anchor.py -q` + evidence API tests. | `api/evidence_chain.py`, `api/forensics.py` |
| DR-009 | Blueprint gap | “BP-M3-003 Evidence verification API” (BLUEPRINT_STAGED.md:L143) | “BP-M3-003”: “MISSING” (tools/align_score_map.json:L22) | HIGH | Add `/evidence/verify` endpoint with deterministic verification response. | Add new `pytest tests/test_evidence_verify.py -q`. | `api/evidence.py` (new), `api/main.py`, `tests/test_evidence_verify.py` |
| DR-010 | Blueprint gap | “BP-M3-004 Signed artifacts + module identity verification” (BLUEPRINT_STAGED.md:L145) | “BP-M3-004”: “MISSING” (tools/align_score_map.json:L23) | HIGH | Sign evidence artifacts (minisign or KMS) and verify on ingest. | Add CI signature verification step (similar to evidence job). | `api/evidence_artifacts.py`, `jobs/*`, `.github/workflows/ci.yml` |
| DR-011 | Blueprint gap | “BP-M3-005 Replay protection + idempotency enforcement” (BLUEPRINT_STAGED.md:L147) | “BP-M3-005”: “MISSING” (tools/align_score_map.json:L24) | HIGH | Add idempotency keys + replay window enforcement. | Add `pytest tests/test_decision_pipeline_unified.py -q` extensions. | `api/defend.py`, `api/ingest.py`, `tests/*` |
| DR-012 | Blueprint gap | “BP-M3-006 DLQ treated as compliance failure” (BLUEPRINT_STAGED.md:L149) | “BP-M3-006”: “MISSING” (tools/align_score_map.json:L25) | MED | Add DLQ tracking + compliance fail-open prevention. | Add `pytest tests/test_jobs_smoke.py -q` DLQ assertions. | `jobs/*`, `api/ingest_bus.py`, `tests/test_jobs_smoke.py` |
| DR-013 | Blueprint gap | “BP-M3-007 Control mappings 800-53/171 minimum” (BLUEPRINT_STAGED.md:L151) | “BP-M3-007”: “MISSING” (tools/align_score_map.json:L26) | MED | Add compliance mapping artifacts + validation script. | Add `make compliance-cis` gate with mapping check. | `compliance/*`, `scripts/compliance_*` |
| DR-014 | Blueprint gap | “BP-C-001 Exceptions workflow (time-boxed, approved)” (BLUEPRINT_STAGED.md:L157) | “BP-C-001”: “MISSING” (tools/align_score_map.json:L27) | MED | Add exceptions workflow API + audit logging. | Add `pytest tests/test_saas_features.py -q` exception coverage. | `api/exceptions.py` (new), `tests/test_saas_features.py` |
| DR-015 | Blueprint gap | “BP-C-002 Break-glass with auto-expiry + audit artifacts” (BLUEPRINT_STAGED.md:L159) | “BP-C-002”: “MISSING” (tools/align_score_map.json:L28) | MED | Add break-glass API with TTL + audit artifact emission. | Add `pytest tests/test_security_hardening.py -q` coverage. | `api/breakglass.py` (new), `tests/test_security_hardening.py` |
| DR-016 | Blueprint gap | “BP-C-003 Change impact simulation before rollout” (BLUEPRINT_STAGED.md:L161) | “BP-C-003”: “MISSING” (tools/align_score_map.json:L29) | MED | Add simulation endpoint + gating on rollout. | Add `pytest tests/test_sim_validator.py -q` coverage. | `api/governance.py`, `tests/test_sim_validator.py` |
| DR-017 | Blueprint gap | “BP-C-004 Air-gapped mode + offline verification bundles” (BLUEPRINT_STAGED.md:L163) | “BP-C-004”: “MISSING” (tools/align_score_map.json:L30) | MED | Add offline bundle export + verification tooling. | Add `pytest tests/test_jobs_smoke.py -q` bundle checks. | `jobs/*`, `scripts/*` |
| DR-018 | Blueprint gap | “BP-C-005 Tenant sharding + performance SLOs” (BLUEPRINT_STAGED.md:L165) | “BP-C-005”: “MISSING” (tools/align_score_map.json:L31) | MED | Add sharding config + SLO telemetry report. | Add `pytest tests/test_stats_endpoint.py -q` SLO assertions. | `api/stats.py`, `tests/test_stats_endpoint.py` |
| DR-019 | Blueprint gap | “BP-C-006 Governance UI (read-only default; writes audited)” (BLUEPRINT_STAGED.md:L167) | “BP-C-006”: “MISSING” (tools/align_score_map.json:L32) | LOW | Add read-only governance UI + audited mutation endpoints. | Add `make ci-console` with UI audit assertions. | `console/*`, `admin_gateway/*` |
| DR-020 | Ops gap | “BP-S0-001 Deterministic startup + probes” (BLUEPRINT_STAGED.md:L91) | `/health/ready` checks DB + redis + NATS only; no OPA check (api/main.py:L478-L565) | HIGH | Add OPA dependency check when `FG_OPA_ENFORCE=1`. | Add `pytest tests/test_main_integrity.py -q` assertion for OPA readiness. | `api/main.py`, `api/health.py`, `tests/test_main_integrity.py` |
| DR-021 | Security footgun | “BP-S0-002 AuthN/AuthZ fail-closed” (BLUEPRINT_STAGED.md:L93) | Default `NATS_URL = "nats://localhost:4222"` (api/ingest_bus.py:L41-L43) | HIGH | Require authenticated NATS URLs in production and fail on missing credentials. | Add `pytest tests/test_ingest_bus.py -q` check for auth requirements. | `api/ingest_bus.py`, `api/config/startup_validation.py` |
| DR-022 | Runtime fail-open | “Fail-closed (spine): core modules … must fail fast when required components are missing.” (CONTRACT.md:L73-L74) | `api.admin` uses `try/except ImportError` and returns 501 (api/admin.py:L353-L359) | MED | Replace fail-soft import with explicit feature flag and startup validation. | Add `pytest tests/test_spine_module_loading.py -q` coverage for admin module. | `api/admin.py`, `api/config/startup_validation.py`, `tests/test_spine_module_loading.py` |
| DR-023 | Contract mismatch | “SQLite path … default MUST be … `<repo>/state/frostgate.db`” (CONTRACT.md:L120-L127) | `_sqlite_path_from_env` defaults to `/tmp/fg-core.db` (api/main.py:L99-L108) | HIGH | Reuse `api.db._resolve_sqlite_path` in `api/main.py` and drop `/tmp` default. | Add `pytest tests/test_db_path_contract.py -q` check for readiness path. | `api/main.py`, `api/db.py`, `tests/test_db_path_contract.py` |
| DR-024 | Schema missing | “Contracts required for APIs/events/artifacts” (BLUEPRINT_STAGED.md:L45) | Contracts README documents only `contracts/admin/*` and no events/artifacts structure (contracts/README.md:L7-L16) | MED | Update contracts docs and add event schema location references. | Add `make verify-schemas` to doc-lint gate. | `contracts/README.md`, `schemas/README.md` |
| DR-025 | Blueprint gap | “MVP2+: /policy/pin, /policy/rollout, /policy/rollback, /drift, /contracts/status” (BLUEPRINT_STAGED.md:L173) | Governance router only provides `/governance/changes*` endpoints (api/governance.py:L98-L184) | HIGH | Add required policy/rollout/drift endpoints or explicit 501 stubs with CI checks. | Add `pytest tests/test_governance_approval_flow.py -q` extension for endpoints. | `api/governance.py`, `tests/test_governance_approval_flow.py` |
